<style>
ol ul {
   margin-bottom: 20px;
}
</style>
`

---
title: "Zillow - House value"
output: html_notebook
editor_options:
 chunk_output_type: inline
---

Loading library

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(corrplot)
```

Listing all the input files

1. zillow_data_dictionary.xlsx
   - Definition of columns in training datsets


2. properties_2016.csv
   - all the properties with their home features for 2016. Note: Some 2017 new properties don't have any          data yet except for their parcelid's. Those data points should be populated when properties_2017.csv is       available.


3. properties_2017.csv
   - all the properties with their home features for 2017 (released on 10/2/2017)


4. train_2016_v2.csv
   - the training set with transactions from 1/1/2016 to 12/31/2016


5. train_2017.csv
   - the training set with transactions from 1/1/2017 to 9/15/2017 (released on 10/2/2017)


6. Sample_submission.csv
   - Sample submission file

```{r}
list.files("datasets/")
```

# Loading the data

```{r message=FALSE,cache=TRUE}
properties_2016=read_csv("datasets/properties_2016.csv")
properties_2017=read_csv("datasets/properties_2017.csv")

train_2016_v2=read_csv("datasets/train_2016_v2.csv")

train_2017=read_csv("datasets/train_2017.csv")

sample_submission=read_csv("datasets/sample_submission.csv")
```

# Exploratory Analysis

Lets see how many unique houses in the train datasets.

```{r}
unique_house_train_2016=n_distinct(train_2016_v2$parcelid)
cat ("2016 train dataset has ",unique_house_train_2016," unique houses")

unique_house_train_2017=n_distinct(train_2017$parcelid)
cat ("2017 train dataset has ",unique_house_train_2017," unique houses")

c(dim(properties_2016),dim(properties_2017))

# To find if both the files has exactly same houses in them.
c(setdiff(properties_2016$parcelid,properties_2017$parcelid),setdiff(properties_2017$parcelid,properties_2016$parcelid))

dim(sample_submission)
```





Also there are 2985217 datasets in both properties_2016 & properties_2017 . And Houses in both the datasets exactly match. Also it matches the sample_submission file.




I am interested to see how many houses were sold more than once .There were 124 out of 90150 houses that were sold more than once in 2016 (2016 training data)

```{r}

train_2016_v2 %>% group_by(parcelid) %>% summarise(freq=n()) %>% filter(freq>1) %>% arrange(desc(freq))

train_2016_v2 %>% group_by(parcelid) %>% summarise(freq=n()) %>% filter(freq>1) %>% dim()

train_2016_v2 %>% group_by(parcelid) %>% summarise(freq=n()) %>%  dim()

```



Likewise lets see for 2017 trainign data.
There were 196 out of 77414 houses that were sold more than once in 2017 (2016 training data)

```{r}
train_2017 %>% group_by(parcelid) %>% summarise(freq=n()) %>% filter(freq>1) %>% arrange(desc(freq))

train_2017 %>% group_by(parcelid) %>% summarise(freq=n()) %>% filter(freq>1) %>% dim()

train_2017 %>% group_by(parcelid) %>% summarise(freq=n()) %>%  dim()

# To find the number of houses that were sold more than once in 2016 & 2017 (as per training data)
length(which(table(c(train_2016_v2$parcelid,train_2017$parcelid))>1))
```

Above analysis shows there were 2669 houses which were sold more than once between 2016 & 2017 (again only as in trainin data time frame)



Join the train dataset with properties dataset
```{r}
merged_train_2016=left_join(train_2016_v2,properties_2016,by="parcelid")
merged_train_2017=left_join(train_2017,properties_2017,by="parcelid")

merged_train=rbind(merged_train_2016,merged_train_2017)
```

Summary of train data
```{r}
summary(merged_train)
```
# Correcting the datatypes
zip code is a factor variable , convert as factors
```{r}

merged_train$regionidzip=as.factor(merged_train$regionidzip)


```

fips ia another factor variable
```{r}
merged_train$fips=as.factor(merged_train$fips)
```

Airconditioning  ia another factor variable
```{r}
merged_train$airconditioningtypeid=as.factor(merged_train$airconditioningtypeid)
```

Architecture  ia another factor variable
```{r}
merged_train$architecturalstyletypeid=as.factor(merged_train$architecturalstyletypeid)
```

decktypeid - It has only one value - Hence converting Y & N variable and convert as factor varaiable

```{r}
table(merged_train$decktypeid,exclude = NULL)

merged_train=merged_train %>% replace_na(list(decktypeid='N')) %>% mutate(decktypeid=as.factor(recode(decktypeid,'66'='Y')))
```

Has hot tub or spa , convert to binary numeric value
```{r}
merged_train=merged_train %>% replace_na(list(hashottuborspa='N')) %>% mutate(hashottuborspa=as.integer(recode(hashottuborspa,'true'=1,'N'=0)))
```

Heating system type,convert to factors
```{r}
merged_train=merged_train %>% replace_na(list(heatingorsystemtypeid='0')) %>% mutate(heatingorsystemtypeid=as.factor(heatingorsystemtypeid))

```


Pooltypeid10 - Spa or Hot tub
Pooltypeid2 -  Pool with Spa/Hot tub
Pooltypeid7 -   Pool without hot tub


```{r}
merged_train=merged_train %>% replace_na(list(pooltypeid10=0)) %>% mutate(pooltypeid10=as.integer(pooltypeid10))

merged_train=merged_train %>% replace_na(list(pooltypeid2=0)) %>% mutate(pooltypeid2=as.integer(pooltypeid2))

merged_train=merged_train %>% replace_na(list(pooltypeid7=0)) %>% mutate(pooltypeid7=as.integer(pooltypeid7))
```

propertycountylandusecode, replace it with most common value (0100) and convert into factor 

```{r}
merged_train=merged_train %>% replace_na(list(propertycountylandusecode=0100)) %>% mutate(propertycountylandusecode=as.factor(propertycountylandusecode))
```

propertylandusetypeid, replace it with most common value (261) and convert into factor 

```{r}
merged_train=merged_train %>% replace_na(list(propertylandusetypeid='261')) %>% mutate(propertylandusetypeid=as.factor(propertylandusetypeid))
```


Removing below variables based on my gut feeling , but eventually needs to be evaluated.
```{r}
merged_train=merged_train %>% select(-c(propertyzoningdesc,rawcensustractandblock,censustractandblock,regionidcity,yardbuildingsqft17,yardbuildingsqft26))
```


regionidneighborhood
```{r}
merged_train=merged_train %>% replace_na(list(regionidneighborhood='0')) %>% mutate(regionidneighborhood=as.factor(regionidneighborhood))
```


storytypeid - contains only one value, hence numeric flag column
```{r}
merged_train=merged_train %>% replace_na(list(storytypeid='NA')) %>% mutate(storytypeid=as.integer(recode(as.character(storytypeid),"0"="1","NA"="0")))
```

yearbuilt - impute with median value
```{r}
merged_train=merged_train %>% replace_na(list(yearbuilt=1970))
```


typeconstructiontypeid - Convert to factor
```{r}
merged_train=merged_train %>% replace_na(list(typeconstructiontypeid='0')) %>% mutate(typeconstructiontypeid=as.factor(typeconstructiontypeid))
```

taxvaluedollarcnt - impute with median value
```{r}
merged_train=merged_train %>% replace_na(list(structuretaxvaluedollarcnt=134100))
```


landtaxvaluedollarcnt - impute with median value
```{r}
merged_train=merged_train %>% replace_na(list(landtaxvaluedollarcnt=197800))
```

taxamount - impute with median value
```{r}
merged_train=merged_train %>% replace_na(list(taxamount=4501.0))
```


assessmentyear - impute with median value
```{r}
merged_train=merged_train %>% replace_na(list(assessmentyear=2015))
```


taxdelinquencyflag - Convert into binary numeric flag
```{r}
merged_train=merged_train %>% replace_na(list(taxdelinquencyflag='N')) %>% 
  mutate(taxdelinquencyflag=recode(taxdelinquencyflag,'Y'=1,'N'=0))
```

taxdelinquencyyear - Convert to factor
```{r}
merged_train=merged_train %>% replace_na(list(taxdelinquencyyear=0)) %>% 
  mutate(taxdelinquencyyear=as.factor(taxdelinquencyyear))
```

Poolcnt - looks like NA might be zero (i.e they don't have pool )
```{r}
merged_train=merged_train %>% replace_na(list(poolcnt=0))
```

numberofstories - Replace NA with zero as other might not have any stories.
```{r}
table(merged_train$numberofstories,exclude = NULL)
merged_train %>% ggplot(aes(x=as.factor(numberofstories),y=logerror))+geom_bar(stat="summary",fun.y="median")

merged_train=merged_train %>% replace_na(list(numberofstories=0))
```


airconditioningtypeid 

```{r}
table(merged_train$airconditioningtypeid,exclude = NULL)
merged_train %>% ggplot(aes(x=as.factor(airconditioningtypeid),y=logerror))+geom_bar(stat="summary",fun.y="median")

merged_train=merged_train %>% mutate(airconditioningtypeid=as.numeric(airconditioningtypeid)) %>% replace_na(list(airconditioningtypeid='0')) %>% mutate(airconditioningtypeid=as.factor(airconditioningtypeid))
```


# Finding correlation

Extract only numeric features
Find the correlation within the variables 
Eliminate the duplicate variables by seeing high correlation between them
```{r fig.height=12,fig.width=12}
numeric_features=colnames(merged_train[,which(sapply(merged_train,class) %in% c("numeric","integer"))])
#numeric_features

cor_numeric_features=cor(merged_train[,numeric_features],use='pairwise.complete.obs')
corrplot.mixed(cor_numeric_features,tl.cex = 0.8,tl.pos="lt",upper = "circle",number.cex=0.5)
```
From the above correlation plot ,below group of variables are highly correlated

calculatedfinishedsquarefeet , finishedfloor1squarefeet , finishedsquarefeet12 , finishedsquarefeet13 , finishedsquarefeet15 , finishedsquarefeet50, finishedsquarefeet6


Lets keep only the feature with minimun missing values. As per the below results only keep calculatedfinishedsquarefeet

```{r}

sort(colSums(is.na(merged_train[,c("calculatedfinishedsquarefeet" , "finishedfloor1squarefeet" , "finishedsquarefeet12" , "finishedsquarefeet13" , "finishedsquarefeet15" , "finishedsquarefeet50", "finishedsquarefeet6")])),decreasing = T)

merged_train=merged_train %>% select(-c(finishedsquarefeet13,finishedsquarefeet6,finishedsquarefeet15,finishedfloor1squarefeet,finishedsquarefeet50,finishedsquarefeet12))

```



bathroomcnt is highly correlated with calculatedbathnbr,fullbathcnt and as per the below results calculatedbathnbr & fullbathcnt has more missing value, hence removing it.

```{r}
sort(colSums(is.na(merged_train[,c("calculatedbathnbr","bathroomcnt","fullbathcnt")])),decreasing = T)
merged_train=merged_train %>% select(-c(calculatedbathnbr,fullbathcnt))
```


landtaxvaluedollorcnt & taxamount is highly correlated . Going to keep taxamount
```{r}
cor(data.frame(landtaxvaluedollarcnt=merged_train$landtaxvaluedollarcnt,
                  taxamount=merged_train$taxamount,
                  logerror=merged_train$logerror))
merged_train=merged_train %>% select(-landtaxvaluedollarcnt)

```


# Missing data

```{r}
sort(colSums(is.na(merged_train)),decreasing = T)
```


Buildingclasstypeid , since it has 30 observations with '4' & 1 observation with '3' value.
Since not lot of variation in this feature , i am going to remove

```{r}

table(merged_train$buildingclasstypeid,exclude = NULL)
merged_train=merged_train %>% select(-buildingclasstypeid)

```

basementsqft , most of the values are missing , hence removiign from the dataset

```{r}

table(merged_train$basementsqft,exclude = NULL)
merged_train=merged_train %>% select(-basementsqft)

```

Also below features has lot of missing values , hence removing it 
fireplaceflag,architecturalstyletypeid,poolsizesum,fireplacecnt,threequarterbathnbr

```{r}
merged_train=merged_train %>% select(-c(fireplaceflag,architecturalstyletypeid,poolsizesum,fireplacecnt,threequarterbathnbr))
```

